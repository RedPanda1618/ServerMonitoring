version: "3.3"

services:
  node_exporter:
    image: prom/node-exporter:latest
    container_name: node_exporter
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
      - ./textfile_collector_output:/etc/node-exporter/textfile_collector:ro
    command:
      - "--path.procfs=/host/proc"
      - "--path.sysfs=/host/sys"
      - "--path.rootfs=/rootfs"
      - "--collector.hwmon"
      - "--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc|rootfs/var/lib/docker/containers|rootfs/var/lib/docker/overlay2|rootfs/run/docker/netns|rootfs/var/lib/kubelet)($|/)"
      - "--collector.textfile.directory=/etc/node-exporter/textfile_collector"
    ports:
      - "9100:9100"
    restart: unless-stopped
    # limit memory to 1GB
    mem_limit: 1g
    deploy:
      resources:
        limits:
          memory: 1g
    pid: host

  dcgm_exporter:
    image: nvidia/dcgm-exporter:latest
    container_name: dcgm_exporter
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all
    ports:
      - "9400:9400"
    restart: unless-stopped
    privileged: true # Required for DCGM exporter to access hardware information
    pid: host
    profiles:
      - gpu
    # limit memory to 1GB
    mem_limit: 1g
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
        limits:
          memory: 1g

  process_exporter:
    image: ncabatoff/process-exporter:latest
    container_name: process_exporter
    restart: unless-stopped
    ports:
      - "9256:9256"
    pid: host
    volumes:
      - /proc:/host/proc:ro
    command:
      - --procfs=/host/proc
    mem_limit: 1g
    deploy:
      resources:
        limits:
          memory: 1g

  procstat_textfile:
    build: ./procstat-textfile
    container_name: procstat_textfile
    restart: unless-stopped
    privileged: true
    pid: host
    environment:
      - INTERVAL_SECONDS=5
      - OUTPUT_DIR=/textfile
      - TOP_N=0
      - MIN_RSS_BYTES=0
      - MIN_CPU_PERCENT=0
    volumes:
      - ./textfile_collector_output:/textfile
      - /etc/passwd:/etc/passwd:ro
    mem_limit: 256m
    deploy:
      resources:
        limits:
          memory: 256m
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu, utility]

  fluent-package:
    build: ./fluent-package
    container_name: fluent_package_agent
    volumes:
      - ./fluent-package/conf:/fluentd/etc
      - ./fluent-package/log:/fluentd/log
      - /var/log/audit:/mnt/auditlogs:ro
      - /etc/passwd:/etc/passwd:ro
    restart: unless-stopped
    user: root
    environment:
      - HOST_HOSTNAME=${HOSTNAME}
    mem_limit: 2g
    deploy:
      resources:
        limits:
          memory: 2g
